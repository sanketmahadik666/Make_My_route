3. Enhanced Database Schemas
3.1 User & Vehicle Models
Generated javascript
      // Enhanced User Schema
const UserSchema = new mongoose.Schema({
  // Basic Information
  email: { type: String, required: true, unique: true },
  profile: {
    name: String,
    phone: String,
    avatar: String,
    timezone: { type: String, default: 'UTC' },
    language: { type: String, default: 'en' }
  },

  // Behavioral Model (learned from usage)
  behaviorModel: {
    drivingStyle: {
      aggressiveness: { type: Number, min: 0, max: 1, default: 0.5 },
      efficiency: { type: Number, min: 0, max: 1, default: 0.5 },
      consistencyScore: { type: Number, min: 0, max: 1, default: 0.5 },
      avgSpeedTendency: { type: Number, default: 1.0 } // Multiplier vs speed limit
    },
    chargingPreferences: {
      preferredSocRange: {
        minimum: { type: Number, default: 20 }, // Never go below 20%
        comfortable: { type: Number, default: 30 }, // Prefer to charge above 30%
        target: { type: Number, default: 80 } // Usually charge to 80%
      },
      maxWaitTime: { type: Number, default: 15 }, // Minutes
      preferredChargingSpeed: { type: String, enum: ['any', 'fast', 'ultra'], default: 'fast' },
      priceThreshold: { type: Number, default: 0.35 }, // $/kWh threshold
      networkPreferences: [{
        network: String,
        preference: { type: Number, min: 0, max: 1 } // 0 = avoid, 1 = prefer
      }]
    },
    riskTolerance: {
      batteryBuffer: { type: Number, min: 5, max: 30, default: 15 }, // % buffer
      weatherRisk: { type: Number, min: 0, max: 1, default: 0.3 },
      trafficRisk: { type: Number, min: 0, max: 1, default: 0.5 },
      stationReliability: { type: Number, min: 0, max: 1, default: 0.7 }
    },
    routePreferences: {
      priorityWeights: {
        time: { type: Number, min: 0, max: 1, default: 0.3 },
        cost: { type: Number, min: 0, max: 1, default: 0.25 },
        comfort: { type: Number, min: 0, max: 1, default: 0.2 },
        reliability: { type: Number, min: 0, max: 1, default: 0.15 },
        efficiency: { type: Number, min: 0, max: 1, default: 0.1 }
      },
      maxDetourTime: { type: Number, default: 10 }, // Minutes
      avoidHighways: { type: Boolean, default: false },
      preferScenicRoutes: { type: Boolean, default: false }
    },
    lastUpdated: { type: Date, default: Date.now },
    tripCount: { type: Number, default: 0 },
    confidence: { type: Number, min: 0, max: 1, default: 0.1 }
  },

  // Static Preferences (user-defined)
  preferences: {
    units: { type: String, enum: ['metric', 'imperial'], default: 'metric' },
    currency: { type: String, default: 'USD' },
    notifications: {
      chargingReminders: { type: Boolean, default: true },
      routeAlerts: { type: Boolean, default: true },
      priceAlerts: { type: Boolean, default: false },
      weatherWarnings: { type: Boolean, default: true }
    },
    privacy: {
      shareLocation: { type: Boolean, default: false },
      shareUsageData: { type: Boolean, default: true },
      shareWithPartners: { type: Boolean, default: false }
    }
  },

  // Subscription & Features
  subscription: {
    tier: { type: String, enum: ['free', 'premium', 'enterprise'], default: 'free' },
    features: [String],
    expiresAt: Date,
    autoRenew: { type: Boolean, default: false }
  },

  // Usage Statistics
  usage: {
    totalTrips: { type: Number, default: 0 },
    totalDistance: { type: Number, default: 0 }, // km
    totalSavings: { type: Number, default: 0 }, // currency
    avgEfficiency: { type: Number, default: 0 }, // kWh/100km
    lastActive: { type: Date, default: Date.now }
  }
}, {
  timestamps: true,
  toJSON: { virtuals: true },
  toObject: { virtuals: true }
});

// Enhanced Vehicle Schema
const VehicleSchema = new mongoose.Schema({
  userId: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
  
  // Basic Information
  make: { type: String, required: true },
  model: { type: String, required: true },
  year: { type: Number, required: true },
  trim: String,
  color: String,
  
  // Battery Specifications
  battery: {
    capacity: { type: Number, required: true }, // kWh
    usableCapacity: { type: Number, required: true }, // kWh (usually 90-95% of total)
    currentLevel: { type: Number, min: 0, max: 100, default: 80 }, // %
    maxChargingPower: { type: Number, required: true }, // kW
    chargingCurve: [{
      soc: { type: Number, min: 0, max: 100 }, // State of charge %
      power: { type: Number, min: 0 } // Available charging power kW
    }],
    degradation: {
      currentCapacity: { type: Number, default: 100 }, // % of original
      degradationRate: { type: Number, default: 0.02 }, // % per year
      lastAssessment: { type: Date, default: Date.now }
    }
  },

  // Performance Characteristics
  performance: {
    efficiency: {
      rated: { type: Number, required: true }, // kWh/100km EPA/WLTP
      real_world: { type: Number }, // Learned from actual usage
      city: Number,
      highway: Number,
      combined: Number
    },
    range: {
      rated: { type: Number, required: true }, // km
      real_world: Number, // Learned from usage
      winter: Number, // Cold weather range
      highway: Number // Highway range
    },
    weight: Number, // kg
    dragCoefficient: Number,
    frontalArea: Number // m²
  },

  // Charging Specifications
  charging: {
    connectorTypes: [{
      type: { type: String, enum: ['CCS1', 'CCS2', 'CHAdeMO', 'Tesla', 'Type2', 'Type1'] },
      maxPower: Number, // kW
      isPrimary: { type: Boolean, default: false }
    }],
    acCharging: {
      maxPower: Number, // kW
      phases: { type: Number, enum: [1, 3], default: 3 },
      efficiency: { type: Number, default: 0.9 }
    },
    dcCharging: {
      maxPower: Number, // kW
      efficiency: { type: Number, default: 0.95 },
      preconditioning: { type: Boolean, default: false }
    }
  },

  // Learned Behavior Patterns
  learnedPatterns: {
    consumptionPattern: {
      cityDriving: Number, // kWh/100km
      highwayDriving: Number,
      combinedDriving: Number,
      temperatureImpact: [{
        temperature: Number, // °C
        impactFactor: Number // Multiplier
      }],
      drivingStyleImpact: Number, // Efficiency variance based on driving
      confidence: { type: Number, min: 0, max: 1, default: 0.1 }
    },
    chargingPattern: {
      preferredStartSoc: Number,
      preferredEndSoc: Number,
      avgChargingTime: Number, // minutes
      fastChargingTolerance: Number, // How often user accepts fast charging
      priceElasticity: Number // How price-sensitive the user is
    }
  },

  // Maintenance & Health
  maintenance: {
    lastService: Date,
    nextService: Date,
    odometer: { type: Number, default: 0 }, // km
    batteryHealth: { type: Number, min: 0, max: 100, default: 100 }, // %
    issues: [{
      type: String,
      description: String,
      severity: { type: String, enum: ['low', 'medium', 'high'] },
      reportedAt: { type: Date, default: Date.now }
    }]
  },

  // Status
  isActive: { type: Boolean, default: true },
  isDefault: { type: Boolean, default: false },
  lastUsed: { type: Date, default: Date.now }
}, {
  timestamps: true
});
    
IGNORE_WHEN_COPYING_START
content_copy download 
Use code with caution. JavaScript
IGNORE_WHEN_COPYING_END
3.2 Enhanced Station & Route Models
Generated javascript
      // Enhanced Charging Station Schema
const ChargingStationSchema = new mongoose.Schema({
  // Basic Information
  name: { type: String, required: true },
  network: { type: String, required: true },
  operator: String,
  
  // Location Data
  location: {
    type: { type: String, enum: ['Point'], required: true },
    coordinates: { type: [Number], required: true } // [longitude, latitude]
  },
  address: {
    street: String,
    city: String,
    state: String,
    country: String,
    postalCode: String,
    formatted: String
  },
  
  // Connector Information
  connectors: [{
    id: { type: String, required: true },
    type: { type: String, required: true },
    maxPower: { type: Number, required: true }, // kW
    currentType: { type: String, enum: ['AC', 'DC'] },
    availability: {
      status: { type: String, enum: ['available', 'occupied', 'out_of_order', 'reserved'] },
      lastUpdated: { type: Date, default: Date.now },
      estimatedFreeTime: Date,
      confidence: { type: Number, min: 0, max: 1, default: 0.5 }
    },
    pricing: {
      perKwh: Number,
      perMinute: Number,
      sessionFee: Number,
      membershipDiscount: Number,
      timeOfDayPricing: [{
        startHour: Number,
        endHour: Number,
        priceModifier: Number // Multiplier
      }]
    }
  }],

  // Operational Information
  operation: {
    hours: {
      isAlwaysOpen: { type: Boolean, default: false },
      schedule: [{
        dayOfWeek: { type: Number, min: 0, max: 6 }, // 0 = Sunday
        openTime: String, // "HH:MM"
        closeTime: String,
        is24Hours: { type: Boolean, default: false }
      }],
      holidays: [{
        date: Date,
        isOpen: Boolean,
        specialHours: {
          openTime: String,
          closeTime: String
        }
      }]
    },
    accessType: { type: String, enum: ['public', 'restricted', 'private'] },
    accessRequirements: [String], // ['membership', 'payment_card', 'app']
    reservationSupported: { type: Boolean, default: false }
  },

  // Amenities & Features
  amenities: {
    nearby: [{
      type: { type: String, enum: ['restaurant', 'shopping', 'restroom', 'wifi', 'lounge'] },
      name: String,
      distance: Number, // meters
      walkingTime: Number // minutes
    }],
    onSite: [{ type: String, enum: ['restroom', 'wifi', 'lounge', 'vending', 'weather_protection'] }],
    accessibility: {
      wheelchairAccessible: Boolean,
      lightingQuality: { type: String, enum: ['poor', 'adequate', 'good', 'excellent'] },
      securityLevel: { type: String, enum: ['low', 'medium', 'high'] }
    }
  },

  // Performance & Reliability Data
  performance: {
    reliability: {
      uptimePercentage: { type: Number, min: 0, max: 100, default: 95 },
      avgRepairTime: Number, // hours
      lastMaintenance: Date,
      maintenanceSchedule: String
    },
    usage: {
      avgUtilization: { type: Number, min: 0, max: 1 }, // 0-1
      peakHours: [{
        hour: Number,
        utilizationRate: Number
      }],
      avgSessionDuration: Number, // minutes
      avgWaitTime: Number // minutes
    },
    ratings: {
      overall: { type: Number, min: 0, max: 5, default: 0 },
      count: { type: Number, default: 0 },
      breakdown: {
        reliability: { type: Number, min: 0, max: 5 },
        speed: { type: Number, min: 0, max: 5 },
        amenities: { type: Number, min: 0, max: 5 },
        accessibility: { type: Number, min: 0, max: 5 },
        pricing: { type: Number, min: 0, max: 5 }
      }
    }
  },

  // Live Data Integration
  liveData: {
    lastUpdated: { type: Date, default: Date.now },
    dataSource: String, // API provider
    updateFrequency: Number, // seconds
    isReliable: { type: Boolean, default: true }
  },

  // Business Logic Fields
  businessRules: {
    allowReservation: { type: Boolean, default: false },
    maxReservationTime: Number, // minutes
    cancellationPolicy: String,
    loyaltyPrograms: [String],
    partnerships: [String]
  }
}, {
  timestamps: true
});

// Enhanced Route Schema
const RouteSchema = new mongoose.Schema({
  // Route Identification
  userId: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
  vehicleId: { type: mongoose.Schema.Types.ObjectId, ref: 'Vehicle', required: true },
  routeId: { type: String, unique: true }, // Generated unique identifier
  
  // Route Definition
  waypoints: {
    origin: {
      coordinates: { type: [Number], required: true },
      address: String,
      name: String, // POI name if applicable
      type: { type: String, enum: ['address', 'poi', 'coordinates'] }
    },
    destination: {
      coordinates: { type: [Number], required: true },
      address: String,
      name: String,
      type: { type: String, enum: ['address', 'poi', 'coordinates'] }
    },
    intermediate: [{
      coordinates: [Number],
      address: String,
      name: String,
      isCharging: { type: Boolean, default: false },
      stopDuration: Number // minutes
    }]
  },

  // Route Calculation Results
  calculation: {
    primaryRoute: {
      distance: { type: Number, required: true }, // km
      duration: { type: Number, required: true }, // minutes
      geometry: String, // Encoded polyline
      segments: [{
        startCoordinates: [Number],
        endCoordinates: [Number],
        distance: Number,
        duration: Number,
        roadType: String,
        speedLimit: Number,
        elevation: {
          start: Number,
          end: Number,
          profile: [Number] // Elevation points along segment
        },
        consumption: {
          predicted: Number, // kWh
          factors: {
            base: Number,
            elevation: Number,
            speed: Number,
            weather: Number,
            traffic: Number
          }
        }
      }],
      totalConsumption: Number, // kWh
      confidence: { type: Number, min: 0, max: 1 }
    },
    alternatives: [{
      routeType: { type: String, enum: ['fastest', 'shortest', 'most_efficient', 'scenic'] },
      distance: Number,
      duration: Number,
      geometry: String,
      totalConsumption: Number,
      chargingStops: Number,
      costEstimate: Number,
      advantages: [String],
      disadvantages: [String]
    }]
  },

  // Charging Plan
  chargingPlan: {
    isChargingRequired: { type: Boolean, required: true },
    batteryAtDestination: Number, // Predicted SOC %
    stops: [{
      stationId: { type: mongoose.Schema.Types.ObjectId, ref: 'ChargingStation' },
      arrivalTime: Date,
      arrivalSoc: Number, // %
      targetSoc: Number, // %
      chargingDuration: Number, // minutes
      waitTime: Number, // minutes
      cost: Number,
      reason: { type: String, enum: ['required', 'opportunistic', 'buffer'] },
      alternatives: [{
        stationId: mongoose.Schema.Types.ObjectId,
        detourTime: Number,
        cost: Number,
        reason: String
      }]
    }],
    totalChargingTime: Number,
    totalChargingCost: Number,
    bufferEnergy: Number // kWh safety buffer
  },

  // Context & Conditions
  context: {
    departureTime: Date,
    arrivalDeadline: Date,
    weather: {
      current: Object,
      forecast: [Object]
    },
    traffic: {
      current: String,
      predicted: [Object]
    },
    preferences: {
      priority: { type: String, enum: ['time', 'cost', 'comfort', 'efficiency'] },
      maxDetourTime: Number,
      chargingPreferences: Object,
      avoidances: [String]
    }
  },

  // Risk Assessment
  riskAssessment: {
    overallRisk: { type: String, enum: ['low', 'medium', 'high'] },
    riskScore: { type: Number, min: 0, max: 100 },
    factors: [{
      category: String,
      level: String,
      score: Number,
      description: String,
      mitigation: String
    }],
    recommendations: [String]
  },

  // Performance Tracking
  performance: {
    calculationTime: Number, // milliseconds
    dataFreshness: {
      traffic: Date,
      weather: Date,
      stations: Date
    },
    apiCalls: [{
      service: String,
      count: Number,
      responseTime: Number
    }]
  },

  // Status & Lifecycle
  status: { 
    type: String, 
    enum: ['draft', 'calculated', 'active', 'completed', 'cancelled'], 
    default: 'calculated' 
  },
  expiresAt: { type: Date, default: () => new Date(Date.now() + 24 * 60 * 60 * 1000) }, // 24 hours
  lastAccessed: { type: Date, default: Date.now }
}, {
  timestamps: true
});
    

3.3 Trip & Analytics Models
Generated javascript
      // Trip Execution Schema (for completed trips)
const TripSchema = new mongoose.Schema({
  userId: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
  vehicleId: { type: mongoose.Schema.Types.ObjectId, ref: 'Vehicle', required: true },
  routeId: { type: mongoose.Schema.Types.ObjectId, ref: 'Route' },
  
  // Trip Basic Info
  startTime: { type: Date, required: true },
  endTime: Date,
  status: { type: String, enum: ['in_progress', 'completed', 'cancelled'], default: 'in_progress' },
  
  // Planned vs Actual Comparison
  planned: {
    distance: Number,
    duration: Number,
    consumption: Number,
    cost: Number,
    chargingStops: Number
  },
  actual: {
    distance: Number,
    duration: Number,
    consumption: Number,
    cost: Number,
    chargingStops: Number,
    deviations: [{
      type: { type: String, enum: ['route_change', 'unplanned_stop', 'charging_issue'] },
      location: [Number],
      reason: String,
      impact: String,
      timestamp: Date
    }]
  },

  // Detailed Trip Segments
  segments: [{
    startTime: Date,
    endTime: Date,
    startLocation: [Number],
    endLocation: [Number],
    distance: Number,
    avgSpeed: Number,
    consumption: Number,
    efficiency: Number,
    drivingConditions: {
      weather: String,
      traffic: String,
      temperature: Number
    },
    batteryStart: Number,
    batteryEnd: Number
  }],

  // Charging Sessions
  chargingSessions: [{
    stationId: { type: mongoose.Schema.Types.ObjectId, ref: 'ChargingStation' },
    connectorType: String,
    startTime: Date,
    endTime: Date,
    startSoc: Number,
    endSoc: Number,
    energyDelivered: Number, // kWh
    avgPower: Number, // kW
    cost: Number,
    waitTime: Number, // minutes
    issues: [String],
    rating: {
      overall: Number,
      speed: Number,
      reliability: Number,
      amenities: Number
    }
  }],

  // Performance Metrics
  metrics: {
    efficiencyScore: Number, // 0-100
    planAccuracy: Number, // 0-100
    costVariance: Number, // % difference from planned
    timeVariance: Number, // % difference from planned
    stressLevel: { type: String, enum: ['low', 'medium', 'high'] },
    satisfactionScore: Number // 1-10
  },

  // Learning Data
  learningData: {
    consumptionFactors: Object,
    chargingBehavior: Object,
    routePreferences: Object,
    decisionPoints: [{
      timestamp: Date,
      decision: String,
      alternatives: [String],
      outcome: String,
      satisfaction: Number
    }]
  }
}, {
  timestamps: true
});

// Analytics & Insights Schema
const AnalyticsSchema = new mongoose.Schema({
  userId: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
  period: {
    type: { type: String, enum: ['daily', 'weekly', 'monthly', 'yearly'] },
    startDate: Date,
    endDate: Date
  },

  // Driving Analytics
  driving: {
    totalDistance: Number,
    totalTrips: Number,
    avgTripDistance: Number,
    efficiencyTrend: [{
      date: Date,
      efficiency: Number // kWh/100km
    }],
    drivingScore: {
      overall: Number,
      efficiency: Number,
      consistency: Number,
      planning: Number
    }
  },

  // Charging Analytics
  charging: {
    totalSessions: Number,
    totalEnergy: Number, // kWh
    totalCost: Number,
    avgSessionDuration: Number,
    preferredNetworks: [{
      network: String,
      percentage: Number,
      avgCost: Number
    }],
    chargingEfficiency: Number,
    fastChargingRatio: Number
  },

  // Cost Analytics
  costs: {
    totalSpent: Number,
    avgCostPerKm: Number,
    avgCostPerKwh: Number,
    savingsVsGasoline: Number,
    costBreakdown: {
      charging: Number,
      membership: Number,
      other: Number
    }
  },

  // Environmental Impact
  environmental: {
    co2Saved: Number, // kg
    equivalentTrees: Number,
    cleanEnergyUsed: Number, // %
    carbonFootprint: Number // kg CO2
  },

  // Insights & Recommendations
  insights: [{
    category: String,
    type: { type: String, enum: ['achievement', 'improvement', 'trend', 'alert'] },
    title: String,
    description: String,
    actionable: Boolean,
    recommendation: String,
    priority: { type: String, enum: ['low', 'medium', 'high'] }
  }]
}, {
  timestamps: true
});
    

